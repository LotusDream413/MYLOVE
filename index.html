<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>我们的旅行足迹（共享版）</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        html, body {margin:0; padding:0; height:100%;}
        #map {width:100%; height:100%;}
        #noteModal {
            display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%);
            width:600px; padding:20px; background:white; border-radius:8px; z-index:10000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        #noteContent {
            width:100%; height:200px; resize:vertical; margin:10px 0; padding:8px;
            font-size:14px; border:1px solid #ddd; border-radius:4px;
        }
        .modalBtn {
            padding:8px 20px; margin-right:10px; border:none; border-radius:4px;
            cursor:pointer; font-size:14px;
        }
        #saveBtn {background:#4CAF50; color:white;}
        #closeBtn {background:#f44336; color:white;}
        #mask {
            display:none; position:fixed; top:0; left:0; width:100%; height:100%;
            background:rgba(0,0,0,0.5); z-index:9999;
        }
        #loading {
            position:fixed; top:20px; right:20px; padding:10px; background:white;
            border-radius:4px; box-shadow:0 2px 8px rgba(0,0,0,0.1); z-index:9998;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div id="loading">加载共享旅行记录中...</div>
    <div id="mask"></div>
    <div id="noteModal">
        <h3 id="cityTitle">旅行感想 - 【城市名】</h3>
        <textarea id="noteContent" placeholder="写下你的旅行感想吧..."></textarea>
        <button id="saveBtn" class="modalBtn" onclick="saveNote()">保存</button>
        <button id="closeBtn" class="modalBtn" onclick="closeModal()">取消</button>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script>
        // 配置（只改这1处：你的共享密码）
        const SHARE_PASSWORD = "1015316"; // 改成你想设置的密码，比如 "travel123"
        const GITHUB_USER = "LotusDream413"; // 你的用户名（不用改）
        const GITHUB_REPO = "MYLOVE"; // 你的仓库名（不用改）
        const DATA_FILE = "travel_notes.json"; // 存储记录的文件（不用改）

        var map;
        var currentFeature = null;
        var cityLayer = null;
        var travelNotes = {}; // 所有共享记录

        // 1. 初始化地图
        function initMap() {
            map = L.map('map').setView([35, 105], 4);
            // 高德底图（显示完整中国边界）
            L.tileLayer('https://webrd0{s}.is.autonavi.com/appmaptile?lang=zh_cn&size=1&scale=1&style=8&x={x}&y={y}&z={z}', {
                subdomains: ['1','2','3','4'],
                attribution: '© 高德地图'
            }).addTo(map);

            // 加载城市图层
            $.getJSON('china_cities_4326.geojson', function (data) {
                cityLayer = L.geoJSON(data, {
                    style: function (feature) {
                        // 从共享数据加载状态（亮橙色=去过，灰色=没去过）
                        var visited = travelNotes[feature.properties.name]?.visited || false;
                        return {
                            fillColor: visited ? '#FF8C00' : '#E0E0E0',
                            weight: 1,
                            color: '#666',
                            fillOpacity: 0.7
                        };
                    },
                    onEachFeature: function (feature, layer) {
                        // 鼠标悬停高亮+显示城市名
                        layer.on('mouseover', function () {
                            this.setStyle({weight:3, color:'#FF0000', fillOpacity:0.9});
                            this.bindTooltip(feature.properties.name).openTooltip();
                        });
                        layer.on('mouseout', function () {
                            var visited = travelNotes[feature.properties.name]?.visited || false;
                            this.setStyle({
                                fillColor: visited ? '#FF8C00' : '#E0E0E0',
                                weight:1, color:'#666', fillOpacity:0.7
                            });
                            this.closeTooltip();
                        });
                        // 点击城市打开输入弹窗
                        layer.on('click', function () {
                            currentFeature = feature;
                            $('#cityTitle').text('旅行感想 - ' + feature.properties.name);
                            // 加载已保存的共享感想
                            $('#noteContent').val(travelNotes[feature.properties.name]?.notes || '');
                            $('#mask').show();
                            $('#noteModal').show();
                        });
                    }
                }).addTo(map);
            });
        }

        // 2. 加载共享记录（从GitHub仓库读取）
        function loadTravelNotes() {
            $.getJSON(`https://raw.githubusercontent.com/${GITHUB_USER}/${GITHUB_REPO}/main/${DATA_FILE}`, function (data) {
                travelNotes = data;
                $('#loading').text('共享记录加载完成！');
                setTimeout(() => $('#loading').hide(), 1000);
                initMap(); // 加载完数据再显示地图
            }).fail(function () {
                // 首次使用，创建空记录
                travelNotes = {};
                $('#loading').text('首次使用，创建新记录！');
                setTimeout(() => $('#loading').hide(), 1000);
                initMap();
            });
        }

        // 3. 保存感想（先验证密码）
        function saveNote() {
            if (!currentFeature) return;
            
            // 第一步：输入密码验证
            var inputPwd = prompt("请输入共享密码才能保存：");
            if (inputPwd !== SHARE_PASSWORD) {
                alert('密码错误！无法保存');
                return;
            }

            // 第二步：获取输入的感想
            var cityName = currentFeature.properties.name;
            var noteText = $('#noteContent').val();
            
            // 第三步：更新共享数据
            travelNotes[cityName] = {
                visited: true, // 标记为去过（城市亮橙色）
                notes: noteText // 保存感想
            };

            // 第四步：保存到GitHub仓库
            saveToGitHub();
        }

        // 4. 保存到GitHub仓库（核心逻辑）
        function saveToGitHub() {
            // 先获取文件SHA（用于更新）
            $.ajax({
                url: `https://api.github.com/repos/${GITHUB_USER}/${GITHUB_REPO}/contents/${DATA_FILE}`,
                success: function (res) {
                    // 更新已有文件
                    updateFile(res.sha);
                },
                error: function () {
                    // 创建新文件（首次保存）
                    createNewFile();
                }
            });
        }

        // 5. 更新已有文件
        function updateFile(sha) {
            $.ajax({
                url: `https://api.github.com/repos/${GITHUB_USER}/${GITHUB_REPO}/contents/${DATA_FILE}`,
                method: 'PUT',
                data: JSON.stringify({
                    message: '更新旅行记录：' + currentFeature.properties.name,
                    content: btoa(unescape(encodeURIComponent(JSON.stringify(travelNotes)))),
                    sha: sha
                }),
                success: function () {
                    alert('保存成功！所有人都能看到这条记录～');
                    cityLayer.resetStyle(currentFeature); // 城市立刻亮橙色
                    closeModal();
                },
                error: function (err) {
                    alert('保存失败：' + err.responseText);
                }
            });
        }

        // 6. 创建新文件
        function createNewFile() {
            $.ajax({
                url: `https://api.github.com/repos/${GITHUB_USER}/${GITHUB_REPO}/contents/${DATA_FILE}`,
                method: 'PUT',
                data: JSON.stringify({
                    message: '初始化旅行记录',
                    content: btoa(unescape(encodeURIComponent(JSON.stringify(travelNotes))))
                }),
                success: function () {
                    alert('保存成功！所有人都能看到这条记录～');
                    cityLayer.resetStyle(currentFeature); // 城市立刻亮橙色
                    closeModal();
                },
                error: function (err) {
                    alert('保存失败：' + err.responseText);
                }
            });
        }

        // 7. 关闭弹窗
        function closeModal() {
            $('#mask').hide();
            $('#noteModal').hide();
            currentFeature = null;
        }

        // 页面加载后先加载共享记录
        $(document).ready(function () {
            loadTravelNotes();
        });
    </script>
</body>
</html>
