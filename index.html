<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>我们的旅行足迹（共享版）</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        html, body {margin:0; padding:0; height:100%;}
        #map {width:100%; height:100%;}
        #noteModal {
            display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%);
            width:600px; padding:20px; background:white; border-radius:8px; z-index:10000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        #noteContent {
            width:100%; height:200px; resize:vertical; margin:10px 0; padding:8px;
            font-size:14px; border:1px solid #ddd; border-radius:4px;
        }
        .modalBtn {
            padding:8px 20px; margin-right:10px; border:none; border-radius:4px;
            cursor:pointer; font-size:14px;
        }
        #saveBtn {background:#4CAF50; color:white;}
        #closeBtn {background:#f44336; color:white;}
        #mask {
            display:none; position:fixed; top:0; left:0; width:100%; height:100%;
            background:rgba(0,0,0,0.5); z-index:9999;
        }
        #loading {
            position:fixed; top:20px; right:20px; padding:10px; background:white;
            border-radius:4px; box-shadow:0 2px 8px rgba(0,0,0,0.1); z-index:9998;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div id="loading">加载共享旅行记录中...</div>
    <div id="mask"></div>
    <div id="noteModal">
        <h3 id="cityTitle">旅行感想 - 【城市名】</h3>
        <textarea id="noteContent" placeholder="写下你的旅行感想吧..."></textarea>
        <button id="saveBtn" class="modalBtn" onclick="saveNote()">保存</button>
        <button id="closeBtn" class="modalBtn" onclick="closeModal()">取消</button>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script>
        // 配置（只改这2处）
        const GITHUB_USER = "LotusDream413";   // 你的用户名
        const GITHUB_REPO = "MYLOVE";          // 你的仓库名
        const DATA_FILE = "travel_notes.json"; // 不用改

        var map;
        var currentFeature = null;
        var cityLayer = null;
        var travelNotes = {};

        // 1. 初始化地图
        function initMap() {
            map = L.map('map').setView([35, 105], 4);
            L.tileLayer('https://webrd0{s}.is.autonavi.com/appmaptile?lang=zh_cn&size=1&scale=1&style=8&x={x}&y={y}&z={z}', {
                subdomains: ['1','2','3','4'],
                attribution: '© 高德地图'
            }).addTo(map);

            $.getJSON('china_cities_4326.geojson', function (data) {
                cityLayer = L.geoJSON(data, {
                    style: function (feature) {
                        var visited = travelNotes[feature.properties.name]?.visited || false;
                        return {
                            fillColor: visited ? '#FF8C00' : '#E0E0E0',
                            weight: 1, color: '#666', fillOpacity: 0.7
                        };
                    },
                    onEachFeature: function (feature, layer) {
                        layer.on('mouseover', function () {
                            this.setStyle({weight:3, color:'#FF0000', fillOpacity:0.9});
                            this.bindTooltip(feature.properties.name).openTooltip();
                        });
                        layer.on('mouseout', function () {
                            var visited = travelNotes[feature.properties.name]?.visited || false;
                            this.setStyle({
                                fillColor: visited ? '#FF8C00' : '#E0E0E0',
                                weight:1, color:'#666', fillOpacity:0.7
                            });
                            this.closeTooltip();
                        });
                        layer.on('click', function () {
                            currentFeature = feature;
                            $('#cityTitle').text('旅行感想 - ' + feature.properties.name);
                            $('#noteContent').val(travelNotes[feature.properties.name]?.notes || '');
                            $('#mask').show();
                            $('#noteModal').show();
                        });
                    }
                }).addTo(map);
            });
        }

        // 2. 加载共享记录
        function loadTravelNotes() {
            $.getJSON(`https://raw.githubusercontent.com/${GITHUB_USER}/${GITHUB_REPO}/main/${DATA_FILE}`)
            .done(data => {
                travelNotes = data;
                $('#loading').text('共享记录加载完成！');
                setTimeout(() => $('#loading').hide(), 1000);
                initMap();
            })
            .fail(() => {
                travelNotes = {};
                $('#loading').text('首次使用，创建新记录！');
                setTimeout(() => $('#loading').hide(), 1000);
                initMap();
            });
        }

        // 3. 保存（输入 token）
        function saveNote() {
            if (!currentFeature) return;

            // 输入 GitHub token
            const token = prompt("请输入你的 GitHub Personal Access Token（仅保存时需要）：");
            if (!token) return;

            const cityName = currentFeature.properties.name;
            const noteText = $('#noteContent').val();

            // 更新数据
            travelNotes[cityName] = {
                visited: true,
                notes: noteText
            };

            // 保存到 GitHub
            saveToGitHub(token);
        }

        // 4. 写入 GitHub
        function saveToGitHub(token) {
            const url = `https://api.github.com/repos/${GITHUB_USER}/${GITHUB_REPO}/contents/${DATA_FILE}`;
            const content = btoa(unescape(encodeURIComponent(JSON.stringify(travelNotes))));

            // 先获取 SHA
            $.ajax({
                url,
                headers: { Authorization: `token ${token}` },
                success: res => {
                    // 更新文件
                    $.ajax({
                        url,
                        method: 'PUT',
                        headers: { Authorization: `token ${token}` },
                        data: JSON.stringify({
                            message: `更新 ${currentFeature.properties.name}`,
                            content,
                            sha: res.sha
                        }),
                        success: () => {
                            alert('保存成功！所有人都能看到～');
                            cityLayer.resetStyle(currentFeature);
                            closeModal();
                        },
                        error: err => {
                            alert('保存失败：' + JSON.stringify(err.responseJSON));
                        }
                    });
                },
                error: () => {
                    // 创建新文件
                    $.ajax({
                        url,
                        method: 'PUT',
                        headers: { Authorization: `token ${token}` },
                        data: JSON.stringify({
                            message: '初始化旅行记录',
                            content
                        }),
                        success: () => {
                            alert('保存成功！所有人都能看到～');
                            cityLayer.resetStyle(currentFeature);
                            closeModal();
                        },
                        error: err => {
                            alert('保存失败：' + JSON.stringify(err.responseJSON));
                        }
                    });
                }
            });
        }

        // 5. 关闭弹窗
        function closeModal() {
            $('#mask').hide();
            $('#noteModal').hide();
            currentFeature = null;
        }

        // 启动
        $(document).ready(loadTravelNotes);
    </script>
</body>
</html>
