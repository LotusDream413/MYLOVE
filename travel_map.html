<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>我的旅行足迹</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        html, body {margin:0; padding:0; height:100%;}
        #map {width:100%; height:100%;}
        #noteModal {
            display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%);
            width:600px; padding:20px; background:white; border-radius:8px; z-index:10000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        #noteContent {
            width:100%; height:200px; resize:vertical; margin:10px 0; padding:8px;
            font-size:14px; border:1px solid #ddd; border-radius:4px;
        }
        .modalBtn {
            padding:8px 20px; margin-right:10px; border:none; border-radius:4px;
            cursor:pointer; font-size:14px;
        }
        #saveBtn {background:#4CAF50; color:white;}
        #closeBtn {background:#f44336; color:white;}
        #mask {
            display:none; position:fixed; top:0; left:0; width:100%; height:100%;
            background:rgba(0,0,0,0.5); z-index:9999;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div id="mask"></div>
    <div id="noteModal">
        <h3 id="cityTitle">旅行感想 - 【城市名】</h3>
        <textarea id="noteContent" placeholder="写下你的旅行感想吧..."></textarea>
        <button id="saveBtn" class="modalBtn" onclick="saveNote()">保存</button>
        <button id="closeBtn" class="modalBtn" onclick="closeModal()">取消</button>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script>
        // 1. 初始化地图（定位中国）
        var map = L.map('map').setView([35, 105], 4);
        // 高德底图（显示九段线+中国地图）
        L.tileLayer('https://webrd0{s}.is.autonavi.com/appmaptile?lang=zh_cn&size=1&scale=1&style=8&x={x}&y={y}&z={z}', {
            subdomains: ['1','2','3','4'],
            attribution: '© 高德地图'
        }).addTo(map);

        var currentFeature = null;
        var cityLayer = null;

        // 2. 加载中国城市图层（核心）
        $.getJSON('china_cities_4326.geojson', function (data) {
            // 创建城市图层，实现样式区分
            cityLayer = L.geoJSON(data, {
                style: function (feature) {
                    // 去过的城市橙色，没去过的浅灰色
                    var visited = localStorage.getItem('visited_' + feature.properties.name) === 'true';
                    return {
                        fillColor: visited ? '#FF8C00' : '#E0E0E0',
                        weight: 1,
                        color: '#666',
                        fillOpacity: 0.7
                    };
                },
                onEachFeature: function (feature, layer) {
                    // 鼠标悬停高亮+显示城市名
                    layer.on('mouseover', function () {
                        this.setStyle({
                            weight: 3,
                            color: '#FF0000',
                            fillOpacity: 0.9
                        });
                        this.bindTooltip(feature.properties.name).openTooltip();
                    });
                    // 鼠标离开恢复样式
                    layer.on('mouseout', function () {
                        var visited = localStorage.getItem('visited_' + feature.properties.name) === 'true';
                        this.setStyle({
                            fillColor: visited ? '#FF8C00' : '#E0E0E0',
                            weight: 1,
                            color: '#666',
                            fillOpacity: 0.7
                        });
                        this.closeTooltip();
                    });
                    // 点击城市打开输入弹窗
                    layer.on('click', function () {
                        currentFeature = feature;
                        $('#cityTitle').text('旅行感想 - ' + feature.properties.name);
                        // 回显已保存的感想
                        $('#noteContent').val(localStorage.getItem('note_' + feature.properties.name) || '');
                        $('#mask').show();
                        $('#noteModal').show();
                    });
                }
            }).addTo(map);
        });

        // 3. 保存旅行感想
        function saveNote() {
            if (!currentFeature) return;
            var cityName = currentFeature.properties.name;
            var noteText = $('#noteContent').val();
            // 保存状态和感想到本地（刷新不丢）
            localStorage.setItem('visited_' + cityName, 'true');
            localStorage.setItem('note_' + cityName, noteText);
            // 刷新图层样式（立即变橙色）
            cityLayer.resetStyle(currentFeature);
            closeModal();
        }

        // 4. 关闭弹窗
        function closeModal() {
            $('#mask').hide();
            $('#noteModal').hide();
            currentFeature = null;
        }
    </script>
</body>
</html>